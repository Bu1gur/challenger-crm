import React, { useState, useEffect } from "react";
import Filters from "./Filters";
import Table from "./Table";
import ClientModal, { empty } from "./ClientModal";
import * as XLSX from "xlsx";
import { saveAs } from "file-saver";
import { API_ENDPOINTS } from "../config/api";

const ClientPanel = ({
	periods = [],
	groups = [],
	payments = [],
	freezeSettings,
	setPeriods,
	setGroups,
	setPayments,
	setFreezeSettings,
	clients,
	setClients,
}) => {
	const [filter, setFilter] = useState({ search: "", trainer: "", status: "" });
	const [modal, setModal] = useState({ open: false, editId: null });
	const [showAll, setShowAll] = useState(false);
	const [loading, setLoading] = useState(false);
	const [error, setError] = useState(null);

	// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
	const fetchClients = () => {
		setLoading(true);
		setError(null);
		fetch(API_ENDPOINTS.CLIENTS)
			.then((res) => {
				if (!res.ok) throw new Error(res.statusText);
				return res.json();
			})
			.then(setClients)
			.catch((e) => {
				setClients([]);
				setError(e.message);
				console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:", e);
			})
			.finally(() => setLoading(false));
	};

	useEffect(() => {
		fetchClients();
	}, []);

	// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
	const handleSave = async (client) => {
		console.log("[CRM] handleSave –≤—ã–∑–≤–∞–Ω —Å –∫–ª–∏–µ–Ω—Ç–æ–º:", client);
		setLoading(true);
		setError(null);
		
		try {
			// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º camelCase –≤ snake_case –¥–ª—è API –∏ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–æ–ª—è
			const apiClient = {
				contract_number: client.contractNumber || "",
				name: client.name || "",
				surname: client.surname || "",
				phone: client.phone || "",
				address: client.address || "",
				birth_date: client.birthDate || "",
				start_date: client.startDate || "",
				end_date: client.endDate || "",
				subscription_period: client.subscriptionPeriod || "",
				payment_amount: client.paymentAmount || "",
				payment_method: client.paymentMethod || "",
				group: client.group || "",
				comment: client.comment || "",
				status: client.status || "–ê–∫—Ç–∏–≤–µ–Ω",
				paid: client.paid || false,
				total_sessions: client.totalSessions || 0,
				has_discount: client.hasDiscount || false,
				discount_reason: client.discountReason || "",
				trainer: client.trainer || ""
			};
			
			// –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º, –¥–æ–±–∞–≤–ª—è–µ–º ID
			if (client.id) {
				apiClient.id = client.id;
			}
			
			console.log("[CRM] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API:", apiClient);
			console.log("[CRM] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π:");
			console.log("client.contractNumber:", client.contractNumber, "-> contract_number:", apiClient.contract_number);
			console.log("client.birthDate:", client.birthDate, "-> birth_date:", apiClient.birth_date);
			console.log("client.startDate:", client.startDate, "-> start_date:", apiClient.start_date);
			
			let response;
			if (client.id) {
				// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
				response = await fetch(`${API_ENDPOINTS.CLIENTS}/${client.id}`, {
					method: "PUT",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(apiClient),
				});
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				const updated = await response.json();
				console.log("[CRM] –ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:", updated);
				setClients((prev) =>
					prev.map((c) => (c.id === updated.id ? updated : c))
				);
				setModal({ open: false, editId: null, forceEdit: false });
			} else {
				// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
				console.log("[CRM] –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:", apiClient);
				response = await fetch(API_ENDPOINTS.CLIENTS, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(apiClient),
				});
				
				console.log("[CRM] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ POST:", response.status, response.statusText);
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				const newClient = await response.json();
				console.log("[CRM] –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:", newClient);
				setClients((prev) => [...prev, newClient]);
				setModal({ open: false, editId: null });
			}
		} catch (error) {
			console.error("[CRM] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:", error);
			setError(error.message);
			throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è ClientModal
		} finally {
			setLoading(false);
		}
	};

	// –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤ –±–∞–∑–µ)
	const handleDelete = (id) => {
		if (window.confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
			fetch(`${API_ENDPOINTS.CLIENTS}/${id}`, { method: "DELETE" })
				.then(() => setClients((prev) => prev.filter((c) => c.id !== id)));
		}
	};

	// –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü (–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)
	const handleExtend = (id) => {
		// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
	};

	// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
	const filtered = (clients || []).filter((c) => {
		if (!showAll && c.deleted) return false;
		if (
			filter.search &&
			!(`${c.name} ${c.surname} ${c.phone}`.toLowerCase().includes(filter.search.toLowerCase()))
		)
			return false;
		if (filter.trainer && c.trainer !== filter.trainer) return false;
		if (filter.status && c.status !== filter.status) return false;
		return true;
	});

	// –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –∏ –ø—Ä–æ—á–µ–µ –æ—Å—Ç–∞–≤–ª—è—é –∫–∞–∫ –µ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—É—â–∏–º clients)

	const handleAdd = () => setModal({ open: true, editId: null });
	const handleView = (id) => setModal({ open: true, editId: id }); // –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
	const handleEdit = (id) => setModal({ open: true, editId: id, forceEdit: true }); // –ü—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

	const editingClient = clients.find((c) => c.id === modal.editId) || null;

	// –≠–∫—Å–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ Excel
	const handleExportRefs = () => {
		const wb = XLSX.utils.book_new();
		wb.Props = { Title: "–ö–ª–∏–µ–Ω—Ç—ã CRM" };
		XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clients), "–ö–ª–∏–µ–Ω—Ç—ã");
		const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
		saveAs(new Blob([wbout], { type: "application/octet-stream" }), `clients_${new Date().toISOString().slice(0,10)}.xlsx`);
	};

	// –ò–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Excel
	const handleImport = (e) => {
		const file = e.target.files[0];
		if (!file) return;
		const reader = new FileReader();
		reader.onload = (evt) => {
			const data = new Uint8Array(evt.target.result);
			const workbook = XLSX.read(data, { type: "array" });
			const sheet = workbook.Sheets[workbook.SheetNames[0]];
			const importedClients = XLSX.utils.sheet_to_json(sheet);
			setClients(importedClients);
		};
		reader.readAsArrayBuffer(file);
	};

	// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
	const isEditMode = modal.forceEdit || false;
	const handleForceEdit = (id) => setModal({ open: true, editId: id, forceEdit: true });
	const handleExtendModal = (id) => setModal({ open: true, editId: id, extend: true });
	const handleReset = () => {
		if (window.confirm("–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤?")) setClients([]);
	};

	return (
		<div className="space-y-6">
			<div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
				<h2 className="text-2xl font-bold text-gray-900">
					–ö–ª–∏–µ–Ω—Ç—ã
				</h2>
				<div className="flex flex-wrap gap-3 items-center">
					<button
						className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors"
						onClick={handleAdd}
					>
						+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
					</button>
					<button
						className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors"
						onClick={handleExportRefs}
					>
						–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
					</button>
					<label className="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors cursor-pointer">
						–ò–º–ø–æ—Ä—Ç –∏–∑ Excel
						<input
							type="file"
							accept=".xlsx,.xls"
							onChange={handleImport}
							className="hidden"
						/>
					</label>
					<button
						className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors ${
							showAll 
								? "bg-blue-100 text-blue-800" 
								: "bg-gray-100 text-gray-700 hover:bg-gray-200"
						}`}
						onClick={() => setShowAll((v) => !v)}
					>
						{showAll ? "–°–∫—Ä—ã—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã—Ö" : "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö"}
					</button>
					<button
						className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors"
						onClick={handleReset}
					>
						–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É
					</button>
				</div>
			</div>
			<Filters filter={filter} setFilter={setFilter} clients={clients} />
			<Table
				clients={filtered}
				onView={handleView}
				onEdit={handleEdit}
				onDelete={handleDelete}
				periods={periods}
				groups={groups}
				onExtend={handleExtend}
			/>
			{filtered.length === 0 && (
				<div className="flex flex-col items-center justify-center py-12 text-gray-500">
					<span className="text-4xl mb-4">üìã</span>
					<div className="text-xl font-medium mb-2">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
					<div className="text-sm">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</div>
				</div>
			)}
			{modal.open && !isEditMode && !modal.extend && (
				<ClientModal
					client={editingClient}
					onSave={handleSave}
					onClose={() => setModal({ open: false, editId: null })}
					periods={periods}
					groups={groups}
					payments={payments}
					freezeSettings={freezeSettings}
					onEdit={handleForceEdit}
					onExtend={handleExtendModal}
					onDelete={handleDelete}
				/>
			)}
			{modal.open && isEditMode && (
				<ClientModal
					client={editingClient}
					onSave={handleSave}
					onClose={() => setModal({ open: false, editId: null, forceEdit: false })}
					periods={periods}
					groups={groups}
					payments={payments}
					freezeSettings={freezeSettings}
					editMode={true}
					onEdit={handleEdit}
					onExtend={handleExtendModal}
					onDelete={handleDelete}
				/>
			)}
			{modal.open && modal.extend && (
				<ClientModal
					client={editingClient}
					onSave={handleSave}
					onClose={() => setModal({ open: false, editId: null, extend: false })}
					periods={periods}
					groups={groups}
					payments={payments}
					freezeSettings={freezeSettings}
					extendMode={true}
					onEdit={handleEdit}
					onExtend={handleExtendModal}
					onDelete={handleDelete}
				/>
			)}
			{loading && (
				<div className="text-center text-blue-400 font-bold py-4 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
			)}
			{error && (
				<div className="text-center text-red-500 font-bold py-2">–û—à–∏–±–∫–∞: {error}</div>
			)}
		</div>
	);
};

export default ClientPanel;
